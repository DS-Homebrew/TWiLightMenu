/*
	dsbize (dsbooter-ize)
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/stat.h>

//ARM7 not officially supported
#if defined(ARM9) || defined(ARM7)
#include <nds.h>
#include "_console.h"
#define printf _consolePrintf
#else
typedef unsigned int u32;
typedef unsigned char byte;
#endif

unsigned char dsbhead[512]={
  0x2e,0x00,0x00,0xea,0x24,0xff,0xae,0x51,0x69,0x9a,0xa2,0x21,0x3d,0x84,0x82,0x0a,
  0x84,0xe4,0x09,0xad,0x11,0x24,0x8b,0x98,0xc0,0x81,0x7f,0x21,0xa3,0x52,0xbe,0x19,
  0x93,0x09,0xce,0x20,0x10,0x46,0x4a,0x4a,0xf8,0x27,0x31,0xec,0x58,0xc7,0xe8,0x33,
  0x82,0xe3,0xce,0xbf,0x85,0xf4,0xdf,0x94,0xce,0x4b,0x09,0xc1,0x94,0x56,0x8a,0xc0,
  0x13,0x72,0xa7,0xfc,0x9f,0x84,0x4d,0x73,0xa3,0xca,0x9a,0x61,0x58,0x97,0xa3,0x27,
  0xfc,0x03,0x98,0x76,0x23,0x1d,0xc7,0x61,0x03,0x04,0xae,0x56,0xbf,0x38,0x84,0x00,
  0x40,0xa7,0x0e,0xfd,0xff,0x52,0xfe,0x03,0x6f,0x95,0x30,0xf1,0x97,0xfb,0xc0,0x85,
  0x60,0xd6,0x80,0x25,0xa9,0x63,0xbe,0x03,0x01,0x4e,0x38,0xe2,0xf9,0xa2,0x34,0xff,
  0xbb,0x3e,0x03,0x44,0x78,0x00,0x90,0xcb,0x88,0x11,0x3a,0x94,0x65,0xc0,0x7c,0x63,
  0x87,0xf0,0x3c,0xaf,0xd6,0x25,0xe4,0x8b,0x38,0x0a,0xac,0x72,0x21,0xd4,0xf8,0x07,
  0x44,0x53,0x42,0x6f,0x6f,0x74,0x65,0x72,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x30,0x31,0x96,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x6e,0x00,0x00,
  0x0b,0x00,0x00,0xea,0x00,0x00,0x00,0x00,0x38,0x01,0x00,0x00,0x00,0x00,0x00,0x02,
  0x50,0x2b,0x07,0x00,0x2c,0x2d,0x07,0x00,0x00,0x80,0x7f,0x03,0x68,0x96,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x40,0xc6,0xa0,0xe3,0x08,0xc2,0x8c,0xe5,0x00,0x00,0xa0,0xe3,
  0x00,0x10,0xa0,0xe3,0x00,0x20,0xa0,0xe3,0x00,0x30,0xa0,0xe3,0x00,0x40,0xa0,0xe3,
  0x00,0x50,0xa0,0xe3,0x00,0x60,0xa0,0xe3,0x00,0x70,0xa0,0xe3,0x80,0x87,0xa0,0xe3,
  0x94,0x90,0x9f,0xe5,0xff,0x00,0xa8,0xe8,0x09,0x00,0x58,0xe1,0xfc,0xff,0xff,0x1a,
  0x88,0x80,0x9f,0xe5,0x88,0x90,0x9f,0xe5,0xff,0x00,0xa8,0xe8,0x09,0x00,0x58,0xe1,
  0xfc,0xff,0xff,0x1a,0xb0,0x01,0x8c,0xe5,0xb4,0x01,0x8c,0xe5,0xb8,0x01,0x8c,0xe5,
  0x90,0xc0,0x4f,0xe2,0x00,0x00,0x9c,0xe5,0x04,0x10,0x9c,0xe5,0x08,0x20,0x9c,0xe5,
  0x0c,0x00,0x80,0xe0,0x00,0x20,0x82,0xe0,0x02,0x00,0x50,0xe1,0x04,0x30,0x90,0x34,
  0x04,0x30,0x81,0x34,0xfb,0xff,0xff,0x3a,0xac,0xc0,0x4f,0xe2,0x00,0x00,0x9c,0xe5,
  0x04,0x10,0x9c,0xe5,0x08,0x20,0x9c,0xe5,0x0c,0x00,0x80,0xe0,0x00,0x20,0x82,0xe0,
  0x02,0x00,0x50,0xe1,0x04,0x30,0x90,0x34,0x04,0x30,0x81,0x34,0xfb,0xff,0xff,0x3a,
  0xdc,0x10,0x4f,0xe2,0x00,0x00,0x91,0xe5,0x18,0x10,0x9f,0xe5,0x00,0x00,0x81,0xe5,
  0xe0,0x10,0x4f,0xe2,0x00,0x00,0x91,0xe5,0x00,0xf0,0xa0,0xe1,0x00,0x40,0x00,0x02,
  0x00,0x80,0x7f,0x03,0x00,0x00,0x81,0x03,0x24,0xfe,0x7f,0x02,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
};

unsigned int read32(const void *p){
	const unsigned char *x=(const unsigned char*)p;
	return x[0]|(x[1]<<8)|(x[2]<<16)|(x[3]<<24);
}

void write32(void *p, const unsigned int n){
	unsigned char *x=(unsigned char*)p;
	x[0]=n&0xff,x[1]=(n>>8)&0xff,x[2]=(n>>16)&0xff,x[3]=(n>>24)&0xff;
}

int make(const byte *nds,const int ndslen,const char *p,const int key){
	byte *p7=NULL,*p9=NULL;
	u32 l7,l9,a7,a9,a7x,a9x;
	FILE *f=NULL;
	int i=0;

	printf("p9=0x%08x\n",(p9=(byte*)nds+read32(nds+0x20))-nds);
	printf("l9=0x%08x\n",l9=read32(nds+0x2c));
	printf("e9=0x%08x\n",a9=read32(nds+0x24));
	printf("r9=0x%08x\n",a9x=read32(nds+0x28));
	printf("p7=0x%08x\n",(p7=(byte*)nds+read32(nds+0x30))-nds);
	printf("l7=0x%08x\n",l7=read32(nds+0x3c));
	printf("e7=0x%08x\n",a7=read32(nds+0x34));
	printf("r7=0x%08x\n",a7x=read32(nds+0x38));
	if(a9!=a9x||a7!=a7x){
		puts("e9==r9 && e7==r7 condition isn't satisfied. Rebuild nds using ndstool.");return 1;
	}

	//if(p){
		f=fopen(p,"wb");
		//write32(dsbhead+0xc8,0x138);
		write32(dsbhead+0xcc,a9);
		write32(dsbhead+0xd0,l9);
		write32(dsbhead+0xd4,l9+0x138-0x0c);
		write32(dsbhead+0xd8,a7);
		write32(dsbhead+0xdc,l7);
		for(;i<0x200;i++)
			dsbhead[i]=dsbhead[i]^key;
		fwrite(dsbhead,1,0x200,f);
		fwrite(p9,1,l9,f);
		fwrite(p7,1,l7,f);
		fclose(f);
	//}

	return 0;
}

int main(const int argc, const char **argv){
	FILE *f;
	struct stat st;
	byte *p;
	int key;

	if(argc<3){
		//printf("dsbize\n");
		printf("dsbize in out [key]\n");
		return 1;
	}
	key=argv[3]?strtol(argv[3],NULL,0):0;

	if(!(f=fopen(argv[1],"rb+"))){printf("cannot open %s\n",argv[1]);return 1;}
	fstat(fileno(f),&st);
	if(!(p=malloc(st.st_size))){printf("cannot allocate %d bytes for %s\n",(int)st.st_size,argv[1]);return 2;}
	fread(p,1,st.st_size,f);
	fclose(f);
	//printf("Decrypting %s... ",argv[1]);
	make(p,st.st_size,argv[2],key);
	free(p);
	return 0;
}
